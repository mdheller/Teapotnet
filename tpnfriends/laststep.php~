
<?php

	/***********************************************/
	/***   Third step : sender of invitation     ***/
	/*** connects to this page to get receiver's ***/
	/*** info. Connection is complete.           ***/
	/***********************************************/
include_once("dbfunctions.php");

	// TODO :id_request_2 is sent by get (id_request), and tpn_send id as post just to be sure

	// TODO : also check if request hasn't been accepted yet

	$tpn_id_sender = "jotun@teapotnet.org"; // Just for tests

	if(isset($_GET['id_request'])) // TODO : and POST
	{
		$id_request_2 = $_GET['id_request'];
		//$tpn_id_sender = $_POST['tpn_id_sender'];


		// Get dates
		$date_last_step = date('Y-m-d H:i:s');
		$d2 = new DateTime($date_last_step);


		try {
			$bdd = dbConnect();
		}
		catch (Exception $e)
		{
			die('Erreur : ' . $e->getMessage());
			return;
		}

		$req = $bdd->prepare("SELECT date_accepted_1 FROM teapot.tpn_requests WHERE (id_request_2 = ? AND tpn_id_sender = ?);");
		$req->execute(array($id_request_2, $tpn_id_sender)) 
			or die(print_r($req->errorInfo())
			);

		$date_accepted_1 = '';

		while ($donnees = $req->fetch())
		{
			$date_accepted_1 = $donnees['date_accepted_1'];
		}
		$d1 = new DateTime($date_accepted_1);
		$time_between = $d2->diff($d1);

		// Get secret and tpn_id_receiver if request has not been accepted too long ago
		if($time_between->d < 1) // 24 hours
		{

			$req = $bdd->prepare("SELECT secret, tpn_id_receiver FROM teapot.tpn_requests WHERE (id_request_2 = ? AND tpn_id_sender = ?);");
			$req->execute(array($id_request_2, $tpn_id_sender)) 
				or die(print_r($req->errorInfo())
				);

			$secret = '';
			$tpn_id_receiver = '';

			while ($donnees = $req->fetch())
			{
				$secret = $donnees['secret'];
				$tpn_id_receiver = $donnees['tpn_id_receiver'];
			}

			// TODO : Case return of sql query on secret and tpn_id_receiver is empty

			

			// Output in json :
			$output = array("secret" => $secret, "tpn_id_receiver" => $tpn_id_receiver);
			echo json_encode($output, JSON_PRETTY_PRINT);
		}
		else
		{
			echo 'Your friend request has been accepted too long ago !';
		}
		
	}
	else
	{
		echo 'Invalid address';
	}


?>
